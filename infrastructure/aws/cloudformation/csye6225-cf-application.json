{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Cloud Formation to build Application stack",
    "Parameters":{

            "VPC":{
              "Description":"VPC ID to which ec2 instances will be associated",
              "Type":"String"
              
          },
            "SubnetIdwebserver":{
              "Description":"SUbnet ID to associate web server",
              "Type":"String"
              
          },
          
          "S3bucketname":{
            "Description":"S3 bucket name",
            "Type":"String"
            
        },

          "DBsubnetgroup":{
            "Description":"DB Subnet group to associate RDS instance",
            "Type":"String"
            
        },
        "KeyName": {
            "Description": "Name of an EC2 KeyPair to enable SSH access to the instance.",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
          },

          "SSHLocation": {
            "Description": " The IP address range that can be used to access the web server using SSH.",
            "Type": "String",
            "MinLength": "9",
            "MaxLength": "18",
            "Default": "0.0.0.0/0",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
          }
    },
    
    "Resources":{

        "WebServerEC2Instance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
              "ImageId": "ami-9887c6e7",
              "InstanceType": "t2.micro",
              "SecurityGroupIds" : [ {"Ref" : "WebServerSecurityGroup"} ],
              "KeyName"        : { "Ref" : "KeyName" },
              "SubnetId" : {"Ref": "SubnetIdwebserver"},
              "BlockDeviceMappings": [{
                "DeviceName":"/dev/sda1",
                "Ebs":{
                   "VolumeSize":"20",
                   "VolumeType":"gp2",
                   "DeleteOnTermination":"false"
                }}]
             
            }
          },

          
        "WebServerSecurityGroup":{
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties":{
                "GroupDescription" : "Allow access from HTTP and SSH traffic",
                "GroupName": "csye6225-webapp",
                "VpcId": {
                    "Ref": "VPC"
                  },
                  "Tags": [
                    {
                        "Key": "Name",
                        "Value": "csye6225-webapp"
    
                    }
                ],
                "SecurityGroupIngress": [
                {
                    "IpProtocol": "tcp",
                    "FromPort": "80",
                    "ToPort": "80",
                    "CidrIp": "0.0.0.0/0"
                },
                {
                    "IpProtocol": "tcp",
                    "FromPort": "443",
                    "ToPort": "443",
                    "CidrIp": "0.0.0.0/0"
                },
                {
                    "IpProtocol": "tcp",
                    "FromPort": "22",
                    "ToPort": "22",
                    "CidrIp": {
                    "Ref": "SSHLocation"
                    }
                }
                ]
            }

        },

        "Dynamodb":{
            "Type" : "AWS::DynamoDB::Table",
            "Properties" : {
              "AttributeDefinitions" : [ 
                {
                    "AttributeName": "id",
                    "AttributeType": "S"
                  }
        ],
        "ProvisionedThroughput":{
            "ReadCapacityUnits" : 10,
            "WriteCapacityUnits" : 5
        },
              "KeySchema" : [ {
                "AttributeName" : "id" ,
                "KeyType" : "HASH"
              } ],
              "TableName" : "csye6225"
            }

        },

        "S3Bucket":{
            "Type" : "AWS::S3::Bucket",
            "Properties" : {
                "AccessControl": "PublicReadWrite",
               "BucketName" : {"Ref": "S3bucketname"}
            }
          },
       
        
        "RDSInstance":{
            "Type" : "AWS::RDS::DBInstance",
            "Properties" :
            {
              "AllocatedStorage" : "5",
              "DBInstanceClass" : "db.t2.medium",
              "DBInstanceIdentifier" : "csye6225-fall2018",
              "DBName" : "csye6225",
              "DBSubnetGroupName" : {"Ref": "DBsubnetgroup"},
              "Engine" : "mariadb",
              "EngineVersion" : "10.2.12",
              "MasterUsername" : "csye6225master",
              "MasterUserPassword" : "csye6225password",
              "MultiAZ" : "false",
              "Port" : "3306",
              "PubliclyAccessible" : "false",
              "StorageType" : "gp2",
              "VPCSecurityGroups" : [ {"Ref": "DBSecurityGroup"}]
            }
          },

        "DBSecurityGroup":{
          "Type" : "AWS::EC2::SecurityGroup",
          "Properties":{
              "GroupDescription" : "Allow access from web server",
              "GroupName": "csye6225-rds",
              "VpcId": {
                  "Ref": "VPC"
                },
              "Tags": [
                  {
                      "Key": "Name",
                      "Value": "csye6225-rds"
  
                  }
              ],
              "SecurityGroupIngress": [
              {
                  "IpProtocol": "tcp",
                  "FromPort": "3306",
                  "ToPort": "3306",
                  "SourceSecurityGroupId": {"Ref":"WebServerSecurityGroup"}
              }
              ]
          }

      }
        
        
    },
    
    "Outputs": {
        "URL": {
            "Value": {
              "Fn::Join": [
                "",
                [
                  "http://",
                  {
                    "Fn::GetAtt": [
                      "WebServerEC2Instance",
                      "PublicIp"
                    ]
                  }
                ]
              ]
            },
            "Description": "Newly created application URL"
          }
    }
}
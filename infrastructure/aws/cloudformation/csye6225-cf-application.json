{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Cloud Formation to build Application stack",
    "Parameters":{

            "VPC":{
              "Description":"VPC ID to which ec2 instances will be associated",
              "Type":"String"
              
          },
            "SubnetIdwebserver":{
              "Description":"SUbnet ID to associate web server",
              "Type":"String"
              
          },
          
          "S3bucketname":{
            "Description":"S3 bucket name",
            "Type":"String"
            
            
        },

        "WebServerSecurityGroup": {
            "Description":"webserver security group",
            "Type":"String"
            
        },

        "WebserverInstanceProfile":{
            "Description":"InstanceProfile for web server",
            "Type":"String"
            
        },

          "DBsubnetgroup":{
            "Description":"DB Subnet group to associate RDS instance",
            "Type":"String"
            
        },
        "KeyName": {
            "Description": "Name of an EC2 KeyPair to enable SSH access to the instance.",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
          }
    },
    
    "Resources":{

        "WebServerEC2Instance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
              "ImageId": "ami-9887c6e7",
              "InstanceType": "t2.micro",
              "SecurityGroupIds" : [ {"Ref" : "WebServerSecurityGroup"} ],
              "KeyName"        : { "Ref" : "KeyName" },
              "SubnetId" : {"Ref": "SubnetIdwebserver"},
              "IamInstanceProfile": {"Ref":"WebserverInstanceProfile"},
              "Tags": [
                {
                    "Key": "Name",
                    "Value": "webserver"

                }
            ],
              "UserData" : { "Fn::Base64": {
            "Fn::Join" : [
              "",
              [
                "#!/bin/bash -xe\n",
                "sudo yum update -y\n",
                "sudo yum install -y gcc-c++ make\n",
                "sudo yum install -y wget \n",
                "sudo yum install -y unzip \n",
                "echo 'Installing Cloudwatchagent'\n",
                "mkdir -p /tmp/AmazonCloudWatchAgent\n",
                "cd /tmp/AmazonCloudWatchAgent\n",
                "sudo wget https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip \n",
                "sudo unzip AmazonCloudWatchAgent.zip\n",
                "sudo chmod +x install.sh\n",
                "sudo sh install.sh\n",
                "cd /usr/share/\n",
                "sudo mkdir collectd\n",
                "cd collectd/\n",
                "sudo touch types.db\n",
                "cd /opt/aws/amazon-cloudwatch-agent/bin/\n",
                "sudo rm -rf config.json\n",
                "sudo touch config.json\n",
                "sudo chmod 777 config.json\n",
                "echo '{\"agent\":{\"metrics_collection_interval\": 10,\"logfile\":\"/opt/aws/amazon-cloudwatch-agent/logs/amazon-cloudwatch-agent.log\"},\"logs\":{\"logs_collected\": {\"files\": {\"collect_list\": [{\"file_path\": \"/home/centos/webapp/combined.log\",\"log_group_name\": \"csye6225_fall2018\"},{\"file_path\": \"/opt/aws/amazon-cloudwatch-agent/logs/amazon-cloudwatch-agent.log\",\"log_group_name\": \"cloudwatchgentlogs\"}]}}},\"metrics\": {\"namespace\":\"Ec2Metrics\",\"metrics_collected\":{\"collectd\":{\"metrics_aggregation_interval\": 10},\"statsd\":{\"metrics_aggregation_interval\": 10,\"metrics_collection_interval\":30,\"service_address\":\":8125\"}}}}' >> config.json",
                "sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json -s\n",
                "sudo systemctl restart amazon-cloudwatch-agent.service\n",
                "sudo systemctl status  amazon-cloudwatch-agent.service\n",
                "echo 'INSTALLING NODEJS using curl'\n",
                "curl -sL https://rpm.nodesource.com/setup_6.x | sudo -E bash -\n",
                "sudo yum install -y nodejs\n",
                "node -v\n",
                "echo 'Node.JS Installed'\n",
                "python --version\n",
                "echo 'Installing MARIADB'\n",
                "sudo yum install mariadb-server mariadb-libs mariadb -y\n",
                "echo NODE_ENV=dev > /home/centos/.env \n",
                "echo DEPLOYMENT_GROUP_NAME=deploy >> /home/centos/.env \n",
                "echo BUCKETNAME=",{"Ref":"S3bucketname"}," >> /home/centos/.env \n",
                "echo RDS_PASSWORD=csye6225password >> /home/centos/.env \n",
                "echo RDS_USERNAME=csye6225master >>/home/centos/.env \n",
                "echo TARGETARN=arn:aws:sns:us-east-1:",{"Ref":"AWS::AccountId"},":password_reset >>/home/centos/.env \n",
                "echo RDS_HOSTNAME=",{ "Fn::GetAtt": [
                    "RDSInstance",
                    "Endpoint.Address"
                ] }, " >> /home/centos/.env \n",
                "echo 'Getting the CODEDEPLOY Agent'\n",
                "sudo yum install ruby -y\n",
                "sudo yum install wget -y\n",
                "cd /home/centos\n",
                "wget https://aws-codedeploy-us-east-1.s3.amazonaws.com/latest/install\n",
                "chmod +x ./install\n",
                "sudo ./install auto\n",
                "echo 'CODEDEPLOYAGENT Installed'\n",
                "echo 'Starting the CodeDeploy Agent'\n",
                "sudo service codedeploy-agent start\n",
                "sudo service codedeploy-agent status\n",
                "echo 'All installations done'\n"
 
            ]]}
            },

              "BlockDeviceMappings": [{
                "DeviceName":"/dev/sda1",
                "Ebs":{
                   "VolumeSize":"20",
                   "VolumeType":"gp2",
                   "DeleteOnTermination":"true"
                }}]
             
            }
          },

          "RDSInstance":{
            "Type" : "AWS::RDS::DBInstance",
            "Properties" :
            {
              "AllocatedStorage" : "5",
              "DBInstanceClass" : "db.t2.medium",
              "DBInstanceIdentifier" : "csye6225-fall2018",
              "DBName" : "csye6225",
              "DBSubnetGroupName" : {"Ref": "DBsubnetgroup"},
              "Engine" : "mariadb",
              "EngineVersion" : "10.2.12",
              "MasterUsername" : "csye6225master",
              "MasterUserPassword" : "csye6225password",
              "MultiAZ" : "false",
              "Port" : "3306",
              "PubliclyAccessible" : "false",
              "StorageType" : "gp2",
              "VPCSecurityGroups" : [ {"Ref": "DBSecurityGroup"}]
            }
          },


        "Dynamodb":{
            "Type" : "AWS::DynamoDB::Table",
            "Properties" : {
              "AttributeDefinitions" : [ 
                {
                    "AttributeName": "email",
                    "AttributeType": "S"
                  }
        ],
        "ProvisionedThroughput":{
            "ReadCapacityUnits" : 10,
            "WriteCapacityUnits" : 5
        },
              "KeySchema" : [ {
                "AttributeName" : "email" ,
                "KeyType" : "HASH"
              } ],
              "TableName" : "csye6225",
              "TimeToLiveSpecification": {
                "AttributeName": "email",
                "Enabled": "TRUE"
              }

            }
           

        },

        "S3Bucket":{
            "Type" : "AWS::S3::Bucket",
            "Properties" : {
                "AccessControl": "PublicReadWrite",
               "BucketName" : {"Ref": "S3bucketname"}
            }
          },
       

        "DBSecurityGroup":{
          "Type" : "AWS::EC2::SecurityGroup",
          "Properties":{
              "GroupDescription" : "Allow access from web server",
              "GroupName": "csye6225-rds",
              "VpcId": {
                  "Ref": "VPC"
                },
              "Tags": [
                  {
                      "Key": "Name",
                      "Value": "csye6225-rds"
  
                  }
              ],
              "SecurityGroupIngress": [
              {
                  "IpProtocol": "tcp",
                  "FromPort": "3306",
                  "ToPort": "3306",
                  "SourceSecurityGroupId": {"Ref":"WebServerSecurityGroup"}
              }
              ]
          }

      }
        
        
    },
    
    "Outputs": {
        "URL": {
            "Value": {
              "Fn::Join": [
                "",
                [
                  "http://",
                  {
                    "Fn::GetAtt": [
                      "WebServerEC2Instance",
                      "PublicIp"
                    ]
                  }
                ]
              ]
            },
            "Description": "Newly created application URL"
          }
    }
}